# Copilot Agent Instructions for nfc-terminal-image

## Repository Overview

This is a **Buildroot external tree** that builds a custom Linux image for Raspberry Pi Compute Module 4 with:
- ST7703 720x720 MIPI DSI display
- FT6336U touchscreen (I2C0)
- NXP PN7150 NFC controller (I2C1) with kernel driver
- DS3231 RTC (I2C1)

**Size**: Small (~1,700 lines of custom code excluding buildroot)  
**Type**: Embedded Linux build system  
**Languages**: Shell scripts, Makefiles, C (kernel drivers), Device Tree  
**Target**: ARM64 (Cortex-A72), Linux 6.12, Buildroot 2024.02.x

## Build Commands

### Prerequisites
```bash
# Install on Ubuntu/Debian (required before first build)
sudo apt-get install -y build-essential git wget cpio unzip rsync bc \
    libncurses-dev libssl-dev python3 python3-dev python3-setuptools file \
    dosfstools mtools fdisk
```

### Clone Buildroot (required once)
```bash
git clone https://github.com/buildroot/buildroot.git --branch 2024.02.x --depth 1
```

### Build Commands (always run from repository root)
| Command | Purpose | Time |
|---------|---------|------|
| `./build.sh` | Full build (auto-configures if needed) | 30-60 min first, 5-15 min incremental |
| `./build.sh config` | Apply defconfig only | < 1 min |
| `./build.sh menuconfig` | Open Buildroot config menu | Interactive |
| `./build.sh linux-menuconfig` | Open kernel config menu | Interactive |
| `./build.sh savedefconfig` | Save config changes back to defconfig | < 1 min |
| `./build.sh rebuild-kernel` | Rebuild kernel only | 5-10 min |
| `./build.sh clean` | Clean build artifacts | 1 min |

### Rebuild a Specific Package
```bash
cd buildroot
make <package>-rebuild && make
# Examples:
make libnfc-nci-rebuild && make
make pn5xx-i2c-rebuild && make
make st7703-gx040hd-rebuild && make
```

### Output Location
Build outputs are in `buildroot/output/images/`:
- `nfc-terminal.img` - Complete bootable image
- `Image` - Linux kernel
- `rootfs.ext4` - Root filesystem

## Project Layout

```
├── board/nfc-terminal/           # Board-specific files
│   ├── config.txt                # Raspberry Pi boot config
│   ├── cmdline.txt               # Kernel command line
│   ├── genimage.cfg              # Disk image layout
│   ├── linux.config.fragment     # Kernel config additions
│   ├── overlays/nfc-pn7150.dts   # NFC device tree overlay
│   ├── post-build.sh             # Runs after rootfs built (modifies TARGET_DIR)
│   └── post-image.sh             # Runs after build (generates final image)
├── configs/
│   └── nfc_terminal_cm4_defconfig  # Main Buildroot defconfig
├── package/                      # Buildroot external packages
│   ├── libnfc-nci/               # NFC userspace library
│   │   ├── Config.in             # Kconfig options
│   │   ├── libnfc-nci.mk         # Package makefile
│   │   └── S95nfc                # Init script for autostart
│   ├── pn5xx-i2c/                # NFC kernel driver (LOCAL source)
│   │   ├── Config.in
│   │   ├── pn5xx-i2c.mk
│   │   ├── pn5xx_i2c.c           # Driver source (patched for kernel 6.x)
│   │   ├── pn5xx_i2c.h
│   │   └── Makefile
│   └── st7703-gx040hd/           # Display driver (fetches from GitHub)
│       ├── Config.in
│       └── st7703-gx040hd.mk
├── Config.in                     # External tree Kconfig (sources package Config.in files)
├── external.desc                 # External tree name: NFC_TERMINAL
├── external.mk                   # Includes package/*.mk files
├── build.sh                      # Main build script
└── buildroot/                    # Buildroot source (git cloned, in .gitignore)
```

## Critical Knowledge

### Buildroot External Tree Pattern
- `BR2_EXTERNAL_NFC_TERMINAL_PATH` variable points to this repository
- All paths in .mk and defconfig files use this variable for portability
- Package makefiles use Buildroot conventions: `<PKG>_VERSION`, `<PKG>_SITE`, `<PKG>_BUILD_CMDS`, etc.

### Package Types
- **st7703-gx040hd**: Downloads from GitHub, builds kernel module + device tree overlays
- **pn5xx-i2c**: Uses **local source** (`PN5XX_I2C_SITE_METHOD = local`), driver source is in package directory
- **libnfc-nci**: Downloads from GitHub, builds userspace library

### Device Tree Overlays
- Custom overlays go in `board/nfc-terminal/overlays/*.dts`
- They are built by their respective package .mk files
- Installed to `$(BINARIES_DIR)/overlays/` for inclusion in boot partition
- Referenced in `board/nfc-terminal/config.txt` with `dtoverlay=<name>`

### NFC Driver Notes
The pn5xx_i2c kernel driver source is **maintained locally** in this repo because it required patches for Linux 6.x:
- `pr_warning` → `pr_warn`
- `no_llseek` → `noop_llseek`
- `of_get_named_gpio_flags` → `of_get_named_gpio`
- Probe/remove function signature changes

Do NOT use `--enable-alt` flag with libnfc-nci - it uses userspace GPIO which doesn't work on modern kernels.

### Post-Build Scripts
- `post-build.sh`: Modifies `$(TARGET_DIR)` (the rootfs). Creates module load configs, udev rules, init scripts.
- `post-image.sh`: Runs after rootfs is finalized. Copies firmware files, generates `nfc-terminal.img`.

## CI/CD

GitHub Actions workflow (`.github/workflows/build.yml`):
- Triggers on version tags (`v*`) and manual dispatch
- Runs on `ubuntu-22.04`
- Build timeout: 120 minutes
- Uploads `nfc-terminal.img` as artifact
- Creates GitHub release with gzipped image on tags

## Validation Checklist

After making changes, verify:
1. `./build.sh` completes without errors
2. For package changes: `make <package>-rebuild && make` succeeds
3. For defconfig changes: `./build.sh savedefconfig` saves cleanly
4. Output image exists: `ls -la buildroot/output/images/nfc-terminal.img`

## Common Issues

| Issue | Solution |
|-------|----------|
| "Buildroot directory not found" | Run: `git clone https://github.com/buildroot/buildroot.git --branch 2024.02.x --depth 1` |
| Package not rebuilding | Use `make <pkg>-dirclean && make` for a clean rebuild |
| Config changes not taking effect | Run `./build.sh config` to reapply defconfig |
| Kernel module won't compile | Check `board/nfc-terminal/linux.config.fragment` for required kernel configs |

## Trust These Instructions

These instructions have been validated against a working build. Only search for additional information if:
- A specific file path mentioned here doesn't exist
- A command fails with an unexpected error
- The task requires knowledge of Buildroot internals not covered here

For Buildroot-specific questions, refer to the [Buildroot Manual](https://buildroot.org/downloads/manual/manual.html).
